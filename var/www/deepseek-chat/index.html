<!DOCTYPE html>
<html>
<head>
    <title>DeepSeek Chat</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- 
    ============================================================================
    DEEPSEEK CHAT
    ============================================================================
    Alle Design-Entscheidungen und Konventionen sind dokumentiert in:
    /var/www/deepseek-chat/manifest
    
    Bitte lesen und befolgen Sie das Manifest bei allen Änderungen!
    ============================================================================
    -->

    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            background: #121212;
            color: #f0f0f0;
            margin: 0;
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0056b3;
        }
        .server-title-section {
            flex: 1;
        }
        .server-title-section h1 {
            margin-top: 0;
            color: #4dabf7;
            text-align: left;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 0;
            border-bottom: none;
        }
        .server-info {
            font-size: 14px;
            color: #aaa;
            font-weight: normal;
        }
        #chat { 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #444; 
            padding: 10px; 
            margin-bottom: 10px; 
            background: #1e1e1e;
            color: #f0f0f0;
            line-height: 1.5;
        }
        .message-container {
            position: relative;
            margin-bottom: 5px;
            padding-right: 60px;
            padding-bottom: 52px;
        }
        .message-container:hover .delete-message-btn,
        .message-container:hover .download-message-btn {
            display: block;
        }
        .delete-message-btn {
            display: none;
            position: absolute;
            right: 5px;
            top: 2px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            width: 24px;
            height: 20px;
            font-size: 11px;
            cursor: pointer;
            padding: 0;
            line-height: 20px;
            text-align: center;
        }
        .delete-message-btn:hover {
            background: #c82333;
        }
        .download-message-btn {
            display: none;
            position: absolute;
            right: 32px;
            top: 2px;
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 3px;
            width: auto;
            min-width: 24px;
            padding: 0 6px;
            height: 20px;
            font-size: 11px;
            cursor: pointer;
            line-height: 20px;
            text-align: center;
        }
        .download-message-btn:hover {
            background: #003d82;
        }
        .feedback-buttons {
            display: none;
            position: absolute;
            left: 5px;
            bottom: 5px;
            gap: 4px;
            flex-direction: row;
        }
        .message-container:hover .feedback-buttons {
            display: flex;
        }
        .feedback-btn {
            background: #0056b3;
            color: white;
            border: 1px solid #0056b3;
            border-radius: 3px;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            line-height: 1.2;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .feedback-btn:hover {
            background: #003d82;
            border-color: #003d82;
        }
        .feedback-btn.liked {
            background: #0a2f44;
            color: #9ac7ff;
            border-color: #007bff;
        }
        .feedback-btn.disliked {
            background: #5a1e1e;
            color: #ffb3b3;
            border-color: #dc3545;
        }
        .feedback-btn.copied {
            background: #003366;
            color: #99ccff;
            border-color: #0056b3;
        }
        .single-export-dropdown {
            display: none;
            position: absolute;
            right: 5px;
            top: 28px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            z-index: 2000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            min-width: 120px;
        }
        .single-export-dropdown.show {
            display: block;
        }
        .single-export-item {
            padding: 8px 14px;
            color: #f0f0f0;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #444;
            white-space: nowrap;
        }
        .single-export-item:last-child {
            border-bottom: none;
        }
        .single-export-item:hover {
            background: #3d3d3d;
        }
        .user-message {
            color: #4dabf7;
            margin-bottom: 5px;
        }
        .ai-message {
            color: #f0f0f0;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        .message-divider {
            height: 1px;
            background: #444;
            margin: 10px 0;
            opacity: 0.5;
        }
        .thinking-mode {
            background: #1a1a2e !important;
            border-left: 4px solid #28a745 !important;
        }
        .search-mode {
            background: #1a1a2e !important;
            border-left: 4px solid #17a2b8 !important;
        }
        #input { 
            width: 100%;
            padding: 10px; 
            background: #2d2d2d;
            color: #f0f0f0;
            border: 1px solid #444;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .buttons-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
            height: 40px;
        }
        .action-button { 
            padding: 10px 20px; 
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            margin: 0 5px;
        }
        .action-button:hover {
            background: #003d82;
        }
        .dropdown-container {
            position: relative;
            flex: 1;
        }
        .dropdown-button {
            width: 100%;
            padding: 10px 20px;
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dropdown-button:hover {
            background: #003d82;
        }
        .dropdown-arrow {
            margin-left: 10px;
            font-size: 12px;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 45px;
            left: 0;
            right: 0;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            padding: 12px 20px;
            color: #f0f0f0;
            cursor: pointer;
            border-bottom: 1px solid #444;
            transition: background 0.2s;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item:hover {
            background: #3d3d3d;
        }
        .mode-button {
            padding: 10px 20px; 
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            margin: 0 5px;
        }
        .mode-button:hover {
            background: #218838;
        }
        .mode-button.active {
            background: #155724;
            box-shadow: 0 0 0 2px #fff;
        }
        .file-input-wrapper {
            position: relative;
            flex: 1;
            height: 40px;
        }
        #fileUpload {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .mode-indicator {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            display: none;
        }
        .deepthink-indicator {
            background: #155724;
            color: #90ee90;
            border-left: 4px solid #28a745;
        }
        .search-indicator {
            background: #0c5460;
            color: #a6e3ff;
            border-left: 4px solid #17a2b8;
        }
        .mode-active {
            display: block;
        }
        #fileInfo {
            margin: 10px 0;
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            display: none;
        }
        #fileInfo.visible {
            display: block;
        }
        #removeFile {
            background: #dc3545;
            margin-left: 10px;
            padding: 4px 8px;
            font-size: 12px;
        }
        #removeFile:hover {
            background: #c82333;
        }
        .pdf-processing {
            padding: 10px;
            background: #155724;
            color: #90ee90;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .pdf-error {
            padding: 10px;
            background: #721c24;
            color: #f8d7da;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .pdf-progress {
            height: 4px;
            background: #444;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .pdf-progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }
        #settingsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        #settingsPanel {
            background: #1e1e1e;
            border: 2px solid #0056b3;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0056b3;
        }
        .settings-title {
            font-size: 22px;
            font-weight: bold;
            color: #4dabf7;
        }
        .close-settings {
            background: #dc3545;
            border: none;
            color: white;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-settings:hover {
            background: #c82333;
        }
        .settings-group {
            margin-bottom: 25px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border-left: none;
        }
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .group-title {
            font-size: 16px;
            color: #f0f0f0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .group-status {
            font-size: 12px;
            color: #aaa;
            font-style: italic;
        }
        .setting-item {
            margin: 12px 0;
            padding: 12px;
            background: #2d2d2d;
            border-radius: 6px;
            border: 1px solid #333;
            transition: all 0.2s;
        }
        .setting-item:hover {
            background: #333;
            border-color: #444;
        }
        .setting-item.active {
            background: #1e3a5f;
            border-color: #0056b3;
        }
        .setting-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .setting-name {
            font-size: 15px;
            color: #f0f0f0;
            font-weight: normal;
        }
        .setting-description {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
            line-height: 1.4;
            padding-left: 20px;
        }
        .radio-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #666;
            border-radius: 50%;
            position: relative;
            transition: all 0.2s;
        }
        .setting-label input[type="radio"] {
            display: none;
        }
        .setting-label input[type="radio"]:checked + .radio-custom {
            border-color: #4dabf7;
            background-color: #4dabf7;
        }
        .setting-label input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }
        /* =====================================================================
           TOGGLE SWITCH - Datenschutz
           ===================================================================== */
        .toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .toggle-switch {
            position: relative;
            width: 46px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        .toggle-slider {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #444;
            border-radius: 24px;
            transition: background 0.3s;
            cursor: pointer;
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            left: 3px;
            top: 3px;
            background: #aaa;
            border-radius: 50%;
            transition: transform 0.3s, background 0.3s;
        }
        .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
            background: #155724;
        }
        .toggle-switch input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(22px);
            background: #90ee90;
        }
        .setting-item.toggle-active {
            background: #1a2e1a;
            border-color: #28a745;
        }
        /* ===================================================================== */
        .settings-info {
            margin-top: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .info-title {
            font-size: 14px;
            color: #90ee90;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .info-text {
            font-size: 12px;
            color: #aaa;
            line-height: 1.4;
        }
        .save-button {
            width: 100%;
            padding: 14px;
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 25px;
            transition: background 0.3s;
        }
        .save-button:hover {
            background: #003d82;
        }
        #sessionsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        #sessionsPanel {
            background: #1e1e1e;
            border: 2px solid #0056b3;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .session-item {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .session-item:hover {
            background: #333;
            border-color: #0056b3;
        }
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .session-id {
            font-size: 14px;
            color: #4dabf7;
            font-weight: bold;
        }
        .session-date {
            font-size: 12px;
            color: #aaa;
        }
        .session-preview {
            font-size: 12px;
            color: #f0f0f0;
            margin: 8px 0;
            font-style: italic;
        }
        .session-count {
            font-size: 11px;
            color: #aaa;
            margin-bottom: 10px;
        }
        .session-actions {
            display: flex;
            gap: 10px;
        }
        .session-load-btn {
            flex: 1;
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .session-load-btn:hover {
            background: #218838;
        }
        .session-delete-btn {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .session-delete-btn:hover {
            background: #c82333;
        }
        .no-sessions {
            text-align: center;
            padding: 40px;
            color: #aaa;
            font-size: 14px;
        }
        #logOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        #logPanel {
            background: #1e1e1e;
            border: 2px solid #0056b3;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        #logContent {
            font-family: Consolas, Monaco, monospace;
            font-size: 12px;
            color: #f0f0f0;
            white-space: pre-wrap;
            background: #121212;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="server-header">
        <div class="server-title-section">
            <h1 id="serverTitle">DeepSeek Chat Server</h1>
            <div class="server-info" id="serverInfo">IP: Lade Server-Informationen...</div>
        </div>
    </div>
    
    <div id="chat"></div>
    
    <input type="text" id="input" placeholder="Ihre Nachricht hier eingeben...">
    
    <div id="deepThinkIndicator" class="mode-indicator deepthink-indicator">
        DeepThink Modus aktiv: Tiefgehende Analyse wird durchgeführt
    </div>
    <div id="searchIndicator" class="mode-indicator search-indicator">
        Search Modus aktiv: Internet-Recherche wird durchgeführt
    </div>
    
    <div class="buttons-row">
        <button id="sendButton" class="action-button">Senden</button>
        <div class="file-input-wrapper">
            <button id="uploadButton" class="action-button">Datei hochladen</button>
            <input type="file" id="fileUpload" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.csv,.xlsx,.pptx">
        </div>
        <div class="dropdown-container">
            <button id="exportButton" class="dropdown-button">
                Exportieren
                <span class="dropdown-arrow">&#9660;</span>
            </button>
            <div id="exportMenu" class="dropdown-menu">
                <div class="dropdown-item" id="exportPdfBtn">Als PDF herunterladen</div>
                <div class="dropdown-item" id="exportMarkdownBtn">Als Markdown herunterladen</div>
                <div class="dropdown-item" id="exportTxtBtn">Als TXT herunterladen</div>
                <div class="dropdown-item" id="exportRtfBtn">Als RTF herunterladen</div>
                <div class="dropdown-item" id="loadSessionBtn">Chat-Verlauf laden</div>
            </div>
        </div>
        <button id="settingsButton" class="action-button">Einstellungen</button>
    </div>
    
    <div class="buttons-row">
        <button id="deepThinkButton" class="mode-button">DeepThink</button>
        <button id="searchButton" class="mode-button">Search</button>
    </div>
    
    <div class="buttons-row">
        <button id="logButton" class="action-button">Log-Dateien</button>
    </div>
    
    <div id="fileInfo"></div>
    
    <div id="settingsOverlay">
        <div id="settingsPanel">
            <div class="settings-header">
                <div class="settings-title">Chat Einstellungen</div>
                <button class="close-settings" id="closeSettings" title="Schliessen">&times;</button>
            </div>
            
            <div class="settings-group">
                <div class="group-header">
                    <div class="group-title">Anredeform</div>
                    <div class="group-status" id="addressFormStatus">Sie-Form</div>
                </div>
                
                <div class="setting-item" id="sieFormItem">
                    <label class="setting-label" for="sieForm">
                        <span class="setting-name">Sie-Form (formell)</span>
                        <input type="radio" name="addressForm" id="sieForm" value="sie" checked>
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Sie werden mit der formellen Anrede "Sie" angesprochen.
                    </div>
                </div>
                
                <div class="setting-item" id="duFormItem">
                    <label class="setting-label" for="duForm">
                        <span class="setting-name">Du-Form (informell)</span>
                        <input type="radio" name="addressForm" id="duForm" value="du">
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Du wirst mit der informellen Anrede "Du" angesprochen.
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="group-header">
                    <div class="group-title">Standard Modus</div>
                    <div class="group-status" id="defaultModeStatus">Normaler Chat</div>
                </div>
                
                <div class="setting-item" id="chatModeItem">
                    <label class="setting-label" for="chatMode">
                        <span class="setting-name">Normaler Chat</span>
                        <input type="radio" name="defaultMode" id="chatMode" value="chat" checked>
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Standard-Gesprächsmodus für allgemeine Fragen.
                    </div>
                </div>
                
                <div class="setting-item" id="deepthinkModeItem">
                    <label class="setting-label" for="deepthinkMode">
                        <span class="setting-name">DeepThink Modus</span>
                        <input type="radio" name="defaultMode" id="deepthinkMode" value="deepthink">
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Tiefgehende Analyse mit detaillierten Überlegungen.
                    </div>
                </div>
                
                <div class="setting-item" id="searchModeItem">
                    <label class="setting-label" for="searchMode">
                        <span class="setting-name">Search Modus</span>
                        <input type="radio" name="defaultMode" id="searchMode" value="search">
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Recherche-basierte Antworten mit aktuellen Informationen.
                    </div>
                </div>
            </div>

            <!-- ================================================================
                 DATENSCHUTZ - Kein Training
                 ================================================================ -->
            <div class="settings-group">
                <div class="group-header">
                    <div class="group-title">Datenschutz</div>
                    <div class="group-status" id="noTrainingStatus">Aktiv</div>
                </div>

                <div class="setting-item" id="noTrainingItem">
                    <label class="toggle-label" for="noTrainingToggle">
                        <span class="setting-name">Daten nicht für Training verwenden</span>
                        <span class="toggle-switch">
                            <input type="checkbox" id="noTrainingToggle" checked>
                            <span class="toggle-slider"></span>
                        </span>
                    </label>
                    <div class="setting-description" id="noTrainingDescription">
                        Sendet den Header X-No-Training: true an die API.<br>
                        Soweit von der API unterstützt werden Ihre Daten nicht für das Training verwendet.<br>
                        Standard: Eingeschaltet (Opt-Out aktiv).
                    </div>
                </div>
            </div>
            <!-- ================================================================ -->
            
            <div class="settings-info">
                <div class="info-title">Einstellungen werden automatisch gespeichert</div>
                <!-- KORREKTUR: wird dynamisch per updateSettingsUI() gesetzt -->
                <div class="info-text" id="settingsInfoText">
                    Ihre Einstellungen werden lokal in Ihrem Browser gespeichert und bleiben auch nach dem Schließen der Seite erhalten.
                </div>
            </div>
            
            <button class="save-button" id="saveSettings">
                 Einstellungen übernehmen
            </button>
        </div>
    </div>

    <div id="sessionsOverlay">
        <div id="sessionsPanel">
            <div class="settings-header">
                <div class="settings-title">Gespeicherte Chats</div>
                <button class="close-settings" id="closeSessions" title="Schliessen">&times;</button>
            </div>
            <div id="sessionsList"></div>
        </div>
    </div>

    <div id="logOverlay">
        <div id="logPanel">
            <div class="settings-header">
                <div class="settings-title">Log-Dateien</div>
                <button class="close-settings" id="closeLog" title="Schliessen">&times;</button>
            </div>
            <button class="action-button" id="refreshLog" style="width:auto; flex:none; padding: 8px 20px;">Aktualisieren</button>
            <div id="logContent">Lade Log-Dateien...</div>
        </div>
    </div>

    <script>
        const API_URL = '/cgi-bin/deepseek-api.py';
        const SAVE_SESSION_URL = '/cgi-bin/save-session.py';
        const LOAD_SESSION_URL = '/cgi-bin/load-session.py';
        const DELETE_SESSION_URL = '/cgi-bin/delete-session.py';
        const EXPORT_PDF_URL = '/cgi-bin/export-pdf.py';
        const EXPORT_MARKDOWN_URL = '/cgi-bin/export-markdown.py';
        const EXPORT_TXT_URL = '/cgi-bin/export-txt.py';
        const EXPORT_RTF_URL = '/cgi-bin/export-rtf.py';
        const GET_LOG_URL = '/cgi-bin/get-log.py';
        const FEEDBACK_LOG_URL = '/cgi-bin/feedback-log.py';
        
        const SERVER_NAME = 'DeepSeek Chat Server';
        const MAX_CONTEXT_TOKENS = 16000;
        const MAX_CONTEXT_MESSAGES = 20;
        const TOKENS_PER_CHAR = 0.25;
        const MAX_FILE_CONTENT_LENGTH = 15000;
        const MAX_FILE_SIZE_MB = 10;
        const PDF_EXTRACTION_TIMEOUT = 30000;
        const SETTINGS_VERSION = '1.1';
        const SUPPORTED_FILE_FORMATS = ['.txt', '.pdf'];
        const ACCEPTED_FILE_FORMATS = ['.txt', '.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.csv', '.xlsx', '.pptx'];
        
        let isSending = false;
        let currentSessionId = null;
        let messageIdCounter = 0;
        let activeSingleExportDropdown = null;
        
        function generateSessionId() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
            const random = Math.random().toString(36).substring(2, 8);
            return `${dateStr}_${timeStr}_${random}`;
        }
        
        // BUGFIX 1: Korrigierte Umlaut-Ersetzung (ä->ae statt ae->ae)
        function replaceGermanUmlauts(text) {
            if (!text) return text;
            return text
                 .replace(/ä/g, "ae").replace(/ö/g, "oe").replace(/ü/g, "ue").replace(/ß/g, "ss")
                 .replace(/Ä/g, "Ae").replace(/Ö/g, "Oe").replace(/Ü/g, "Ue");
        }
        
        async function loadPDFJSWorker() {
            const cdnUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js',
                'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
            ];
            for (const url of cdnUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (response.ok) return url;
                } catch (error) {
                    console.log(`CDN ${url} nicht erreichbar, versuche naechste...`);
                }
            }
            console.warn('Kein PDF.js Worker verfuegbar');
            return null;
        }
        
        async function extractTextFromPDF(file) {
            return new Promise(async (resolve, reject) => {
                let timeoutId;
                try {
                    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                        throw new Error(`Datei zu groß. Maximale Größe: ${MAX_FILE_SIZE_MB} MB`);
                    }
                    const workerUrl = await loadPDFJSWorker();
                    if (workerUrl) pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
                    const loadingTask = pdfjsLib.getDocument({ data: await file.arrayBuffer() });
                    const pdf = await loadingTask.promise;
                    let fullText = '';
                    const totalPages = pdf.numPages;
                    const progressInfo = document.getElementById('fileInfo');
                    timeoutId = setTimeout(() => {
                        reject(new Error('PDF-Extraktion hat zu lange gedauert.'));
                    }, PDF_EXTRACTION_TIMEOUT);
                    for (let i = 1; i <= totalPages && fullText.length < MAX_FILE_CONTENT_LENGTH; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ') + '\n\n';
                        if (fullText.length + pageText.length > MAX_FILE_CONTENT_LENGTH) {
                            const remainingChars = MAX_FILE_CONTENT_LENGTH - fullText.length;
                            if (remainingChars > 0) fullText += pageText.substring(0, remainingChars);
                            break;
                        } else {
                            fullText += pageText;
                        }
                        if (progressInfo) {
                            const progress = Math.round((i / totalPages) * 100);
                            progressInfo.innerHTML = `
                                <div class="pdf-processing">
                                    PDF wird verarbeitet: Seite ${i}/${totalPages}
                                    <div class="pdf-progress">
                                        <div class="pdf-progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                </div>`;
                        }
                    }
                    clearTimeout(timeoutId);
                    if (fullText.length > MAX_FILE_CONTENT_LENGTH) fullText = fullText.substring(0, MAX_FILE_CONTENT_LENGTH);
                    resolve(fullText);
                } catch (error) {
                    if (timeoutId) clearTimeout(timeoutId);
                    reject(new Error(`PDF-Extraktion fehlgeschlagen: ${error.message}`));
                }
            });
        }
        
        function getServerIP() {
            try {
                const hostname = window.location.hostname;
                if (!hostname || hostname === 'localhost' || hostname === '127.0.0.1') return 'localhost';
                return hostname;
            } catch (error) {
                return 'Unbekannt';
            }
        }
        
        function updateServerTitle() {
            document.getElementById('serverTitle').textContent = SERVER_NAME;
            document.getElementById('serverInfo').textContent = `IP: ${getServerIP()}`;
        }
        
        let contextHistory = {
            systemPromptTokens: 0,
            messages: []
        };
        
        function estimateTokens(text) {
            if (!text) return 0;
            return Math.ceil(text.length * TOKENS_PER_CHAR);
        }
        
        function updateContextEstimation() {
            let total = contextHistory.systemPromptTokens;
            contextHistory.messages.forEach(msg => total += estimateTokens(msg.content));
            contextHistory.totalEstimatedTokens = total;
            return total;
        }
        
        function addUserMessageToContext(content, mode, hasFile) {
            const msgId = ++messageIdCounter;
            const timestamp = new Date().toISOString();
            contextHistory.messages.push({
                id: msgId, role: "user", content, mode, hasFile,
                timestamp, estimatedTokens: estimateTokens(content)
            });
            while (contextHistory.messages.length > MAX_CONTEXT_MESSAGES * 2) contextHistory.messages.shift();
            updateContextEstimation();
            return msgId;
        }
        
        function addAIResponseToContext(content, mode) {
            const msgId = ++messageIdCounter;
            const timestamp = new Date().toISOString();
            contextHistory.messages.push({
                id: msgId, role: "assistant", content, mode,
                timestamp, estimatedTokens: estimateTokens(content)
            });
            while (contextHistory.messages.length > MAX_CONTEXT_MESSAGES * 2) contextHistory.messages.shift();
            updateContextEstimation();
            return msgId;
        }
        
        function updateSystemPromptTokens(prompt) {
            contextHistory.systemPromptTokens = estimateTokens(prompt);
            updateContextEstimation();
        }
        
        async function saveSession() {
            if (!currentSessionId) currentSessionId = generateSessionId();
            try {
                const chatData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    serverInfo: { name: SERVER_NAME, ip: getServerIP() },
                    settings: settings,
                    messages: contextHistory.messages
                };
                const response = await fetch(SAVE_SESSION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: currentSessionId, chatData })
                });
                if (!response.ok) console.error('Session-Speicherung fehlgeschlagen:', response.status);
            } catch (error) {
                console.error('Fehler beim Speichern der Session:', error);
            }
        }
        
        async function loadSessionsList() {
            try {
                const response = await fetch(LOAD_SESSION_URL, { method: 'GET' });
                if (!response.ok) throw new Error('Laden fehlgeschlagen');
                const data = await response.json();
                const sessions = data.sessions || [];
                const sessionsList = document.getElementById('sessionsList');
                if (sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="no-sessions">Keine gespeicherten Chats vorhanden</div>';
                    return;
                }
                sessionsList.innerHTML = sessions.map(session => `
                    <div class="session-item" data-session-id="${session.sessionId}">
                        <div class="session-header">
                            <div class="session-id">${session.sessionId}</div>
                            <div class="session-date">${session.timestamp}</div>
                        </div>
                        <div class="session-preview">"${session.preview}..."</div>
                        <div class="session-count">${session.messageCount} Nachrichten</div>
                        <div class="session-actions">
                            <button class="session-load-btn" onclick="loadSpecificSession('${session.sessionId}')">Laden</button>
                            <button class="session-delete-btn" onclick="deleteSession('${session.sessionId}')">Löschen</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Sessions:', error);
                document.getElementById('sessionsList').innerHTML = '<div class="no-sessions">Fehler beim Laden der Sessions</div>';
            }
        }
        
        async function loadSpecificSession(sessionId) {
            if (confirm('Aktueller Chat wird gespeichert und die ausgewählte Session wird geladen. Fortfahren?')) {
                await saveSession();
                try {
                    const response = await fetch(LOAD_SESSION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId })
                    });
                    if (!response.ok) throw new Error('Laden fehlgeschlagen');
                    const data = await response.json();
                    const chatData = data.chatData;
                    document.getElementById('chat').innerHTML = '';
                    currentSessionId = sessionId;
                    contextHistory.messages = chatData.messages || [];
                    messageIdCounter = Math.max(...contextHistory.messages.map(m => m.id || 0), 0);
                    chatData.messages.forEach(msg => {
                        if (msg.role === 'user') addMessageToChat(msg.content, true, msg.id, msg.mode);
                        else addMessageToChat(msg.content, false, msg.id, msg.mode);
                    });
                    if (chatData.settings) {
                        settings = chatData.settings;
                        updateSettingsUI();
                        setMode(settings.defaultMode);
                        updateInputPlaceholder();
                    }
                    document.getElementById('sessionsOverlay').style.display = 'none';
                } catch (error) {
                    alert('Fehler beim Laden der Session: ' + error.message);
                }
            }
        }
        
        async function deleteSession(sessionId) {
            if (confirm(`Session ${sessionId} wirklich löschen?`)) {
                try {
                    const response = await fetch(DELETE_SESSION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId })
                    });
                    if (!response.ok) throw new Error('Loeschen fehlgeschlagen');
                    await loadSessionsList();
                } catch (error) {
                    alert('Fehler beim Löschen der Session: ' + error.message);
                }
            }
        }
        
        // =====================================================================
        // GESAMT-EXPORT FUNKTIONEN
        // =====================================================================
        
        async function exportPDF() {
            try {
                const chatData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    serverInfo: { name: SERVER_NAME, ip: getServerIP() },
                    settings: settings,
                    messages: contextHistory.messages
                };
                const response = await fetch(EXPORT_PDF_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatData })
                });
                if (!response.ok) throw new Error('PDF-Export fehlgeschlagen');
                const blob = await response.blob();
                triggerDownload(blob, `deepseek-chat-${currentSessionId || 'export'}.pdf`);
            } catch (error) {
                alert('Fehler beim PDF-Export: ' + error.message);
            }
        }
        
        async function exportMarkdown() {
            try {
                const chatData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    serverInfo: { name: SERVER_NAME, ip: getServerIP() },
                    settings: settings,
                    messages: contextHistory.messages
                };
                const response = await fetch(EXPORT_MARKDOWN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatData })
                });
                if (!response.ok) throw new Error('Markdown-Export fehlgeschlagen');
                const blob = await response.blob();
                triggerDownload(blob, `deepseek-chat-${currentSessionId || 'export'}.md`);
            } catch (error) {
                alert('Fehler beim Markdown-Export: ' + error.message);
            }
        }
        
        async function exportTxt() {
            try {
                const chatData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    serverInfo: { name: SERVER_NAME, ip: getServerIP() },
                    settings: settings,
                    messages: contextHistory.messages
                };
                const response = await fetch(EXPORT_TXT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatData })
                });
                if (!response.ok) throw new Error('TXT-Export fehlgeschlagen');
                const blob = await response.blob();
                triggerDownload(blob, `deepseek-chat-${currentSessionId || 'export'}.txt`);
            } catch (error) {
                alert('Fehler beim TXT-Export: ' + error.message);
            }
        }
        
        async function exportRtf() {
            try {
                const chatData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    serverInfo: { name: SERVER_NAME, ip: getServerIP() },
                    settings: settings,
                    messages: contextHistory.messages
                };
                const response = await fetch(EXPORT_RTF_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatData })
                });
                if (!response.ok) throw new Error('RTF-Export fehlgeschlagen');
                const blob = await response.blob();
                triggerDownload(blob, `deepseek-chat-${currentSessionId || 'export'}.rtf`);
            } catch (error) {
                alert('Fehler beim RTF-Export: ' + error.message);
            }
        }
        
        // =====================================================================
        // EINZEL-EXPORT FUNKTIONEN (direkt im Browser, kein Server noetig)
        // =====================================================================
        
        function triggerDownload(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function getMsgText(msgId) {
            const msg = contextHistory.messages.find(m => m.id === msgId);
            return msg ? msg.content : '';
        }
        
        function getMsgRole(msgId) {
            const msg = contextHistory.messages.find(m => m.id === msgId);
            return msg ? msg.role : 'unknown';
        }
        
        function exportSingleAsTxt(msgId) {
            const text = getMsgText(msgId);
            const role = getMsgRole(msgId) === 'user' ? 'User' : 'DeepSeek AI';
            const timestamp = new Date().toLocaleString('de-DE');
            const content = `DeepSeek Chat - Einzelnachricht\nExportiert am: ${timestamp}\n\n${role}:\n${'='.repeat(40)}\n${text}\n`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            triggerDownload(blob, `nachricht-${msgId}.txt`);
        }
        
        function exportSingleAsMarkdown(msgId) {
            const text = getMsgText(msgId);
            const role = getMsgRole(msgId) === 'user' ? 'User' : 'DeepSeek AI';
            const timestamp = new Date().toLocaleString('de-DE');
            const content = `# DeepSeek Chat - Einzelnachricht\n\n**Exportiert am:** ${timestamp}\n\n## ${role}\n\n${text}\n`;
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            triggerDownload(blob, `nachricht-${msgId}.md`);
        }
        
        function exportSingleAsRtf(msgId) {
            const text = getMsgText(msgId);
            const role = getMsgRole(msgId) === 'user' ? 'User' : 'DeepSeek AI';
            const timestamp = new Date().toLocaleString('de-DE');
            const escapedText = text
                .replace(/\\/g, '\\\\')
                .replace(/\{/g, '\\{')
                .replace(/\}/g, '\\}')
                .replace(/\n/g, '\\par\n');
            const escapedRole = role.replace(/\\/g, '\\\\');
            const rtfContent = `{\\rtf1\\ansi\\deff0\n{\\fonttbl{\\f0 Arial;}}\n{\\colortbl;\\red0\\green86\\blue179;\\red40\\green40\\blue40;}\n\\f0\\fs24\n{\\b\\cf1 DeepSeek Chat - Einzelnachricht}\\par\n{\\cf2 Exportiert am: ${timestamp}}\\par\n\\par\n{\\b\\cf1 ${escapedRole}:}\\par\n${'_'.repeat(40)}\\par\n\\par\n${escapedText}\\par\n}`;
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            triggerDownload(blob, `nachricht-${msgId}.rtf`);
        }
        
        async function exportSingleAsPdf(msgId) {
            try {
                const msg = contextHistory.messages.find(m => m.id === msgId);
                if (!msg) return;
                const singleChatData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    serverInfo: { name: SERVER_NAME, ip: getServerIP() },
                    settings: settings,
                    messages: [msg]
                };
                const response = await fetch(EXPORT_PDF_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatData: singleChatData })
                });
                if (!response.ok) throw new Error('PDF-Export fehlgeschlagen');
                const blob = await response.blob();
                triggerDownload(blob, `nachricht-${msgId}.pdf`);
            } catch (error) {
                alert('Fehler beim PDF-Export: ' + error.message);
            }
        }
        
        function showSingleExportDropdown(msgId, btnElement) {
            if (activeSingleExportDropdown) {
                activeSingleExportDropdown.classList.remove('show');
                activeSingleExportDropdown = null;
            }
            const container = btnElement.closest('.message-container');
            let dropdown = container.querySelector('.single-export-dropdown');
            if (!dropdown) {
                dropdown = document.createElement('div');
                dropdown.className = 'single-export-dropdown';
                dropdown.innerHTML = `
                    <div class="single-export-item" data-format="txt">Als TXT</div>
                    <div class="single-export-item" data-format="md">Als Markdown</div>
                    <div class="single-export-item" data-format="rtf">Als RTF</div>
                    <div class="single-export-item" data-format="pdf">Als PDF</div>
                `;
                dropdown.querySelectorAll('.single-export-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const format = item.getAttribute('data-format');
                        dropdown.classList.remove('show');
                        activeSingleExportDropdown = null;
                        if (format === 'txt') exportSingleAsTxt(msgId);
                        else if (format === 'md') exportSingleAsMarkdown(msgId);
                        else if (format === 'rtf') exportSingleAsRtf(msgId);
                        else if (format === 'pdf') exportSingleAsPdf(msgId);
                    });
                });
                container.appendChild(dropdown);
            }
            dropdown.classList.toggle('show');
            activeSingleExportDropdown = dropdown.classList.contains('show') ? dropdown : null;
        }
        
        // =====================================================================
        // FEEDBACK UND REGENERIEREN FUNKTIONEN
        // =====================================================================

        async function sendFeedbackLog(type, msgId, preview) {
            try {
                await fetch(FEEDBACK_LOG_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, msgId, preview })
                });
            } catch (error) {
                console.error('Fehler beim Feedback-Logging:', error);
            }
        }

        function handleLike(msgId, likeBtn, dislikeBtn) {
            const isLiked = likeBtn.classList.contains('liked');
            likeBtn.classList.remove('liked');
            dislikeBtn.classList.remove('disliked');
            likeBtn.textContent = 'Mag ich';
            dislikeBtn.textContent = 'Mag ich gar nicht';
            if (!isLiked) {
                likeBtn.classList.add('liked');
                likeBtn.textContent = 'Mag ich';
                const preview = getMsgText(msgId).substring(0, 60);
                sendFeedbackLog('LIKE', msgId, preview);
            }
        }

        function handleDislike(msgId, likeBtn, dislikeBtn) {
            const isDisliked = dislikeBtn.classList.contains('disliked');
            likeBtn.classList.remove('liked');
            dislikeBtn.classList.remove('disliked');
            likeBtn.textContent = 'Mag ich';
            dislikeBtn.textContent = 'Mag ich gar nicht';
            if (!isDisliked) {
                dislikeBtn.classList.add('disliked');
                dislikeBtn.textContent = 'Mag ich gar nicht';
                const preview = getMsgText(msgId).substring(0, 60);
                sendFeedbackLog('DISLIKE', msgId, preview);
            }
        }

        function handleCopy(msgId, copyBtn) {
            const text = getMsgText(msgId);
            navigator.clipboard.writeText(text).then(() => {
                copyBtn.classList.add('copied');
                copyBtn.textContent = 'Kopiert!';
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.textContent = 'Kopieren';
                }, 2000);
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                copyBtn.classList.add('copied');
                copyBtn.textContent = 'Kopiert!';
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.textContent = 'Kopieren';
                }, 2000);
            });
        }

        // BUGFIX 2: handleRegenerate() mit Streaming
        async function handleRegenerate(msgId) {
            if (isSending) return;

            const msgIndex = contextHistory.messages.findIndex(m => m.id === msgId);
            if (msgIndex === -1) return;

            const userMsg = contextHistory.messages[msgIndex - 1];
            if (!userMsg || userMsg.role !== 'user') return;

            contextHistory.messages = contextHistory.messages.slice(0, msgIndex);
            updateContextEstimation();

            const container = document.querySelector(`[data-msg-id="${msgId}"]`);
            if (container) {
                const nextSibling = container.nextElementSibling;
                if (nextSibling && nextSibling.classList.contains('message-divider')) {
                    nextSibling.remove();
                }
                container.remove();
            }

            isSending = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Wird gesendet...';
            inputField.disabled = true;

            let systemPrompt = settings.addressForm === 'sie' ?
                'Sie sind ein hilfreicher Assistent. Verwenden Sie in allen Antworten konsequent die Sie-Form.' :
                'Du bist ein hilfreicher Assistent. Verwende in allen Antworten konsequent die Du-Form.';
            if (userMsg.mode === 'deepthink') systemPrompt += settings.addressForm === 'sie' ?
                ' Bitte geben Sie eine tiefgehende Analyse mit detaillierten Überlegungen.' :
                ' Bitte gib eine tiefgehende Analyse mit detaillierten Überlegungen.';
            else if (userMsg.mode === 'search') systemPrompt += settings.addressForm === 'sie' ?
                ' Bitte geben Sie eine recherchierte Antwort mit aktuellen Informationen.' :
                ' Bitte gib eine recherchierte Antwort mit aktuellen Informationen.';
            updateSystemPromptTokens(systemPrompt);
            const processedSystem = replaceGermanUmlauts(systemPrompt);

            const aiContainer = document.createElement('div');
            aiContainer.className = 'message-container';
            const aiText = document.createElement('div');
            aiText.className = 'ai-message';
            aiText.textContent = '';
            aiContainer.appendChild(aiText);
            chat.appendChild(aiContainer);
            chat.scrollTop = chat.scrollHeight;

            try {
                const messages = [{ role: 'system', content: processedSystem }];
                contextHistory.messages.forEach(msg => {
                    messages.push({ role: msg.role, content: replaceGermanUmlauts(msg.content) });
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages,
                        max_tokens: 2000,
                        no_training: settings.noTraining
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API-Fehler (${response.status}): ${errorText}`);
                }

                // STREAMING fuer Regenerate
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6).trim();
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                if (data.choices && data.choices[0] && data.choices[0].delta) {
                                    const token = data.choices[0].delta.content || '';
                                    if (token) {
                                        fullText += token;
                                        aiText.textContent = fullText;
                                        chat.scrollTop = chat.scrollHeight;
                                    }
                                }
                            } catch (e) {
                                // Ignoriere Parse-Fehler
                            }
                        }
                    }
                }

                const aiMsgId = addAIResponseToContext(fullText, userMsg.mode);
                aiContainer.setAttribute('data-msg-id', aiMsgId);
                addFeedbackButtons(aiContainer, aiMsgId);
                const dlBtn = document.createElement('button');
                dlBtn.className = 'download-message-btn';
                dlBtn.textContent = 'Exportieren';
                dlBtn.onclick = (e) => { e.stopPropagation(); showSingleExportDropdown(aiMsgId, dlBtn); };
                aiContainer.appendChild(dlBtn);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-message-btn';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => deleteMessage(aiMsgId);
                aiContainer.appendChild(deleteBtn);
                chat.appendChild(document.createElement('div')).className = 'message-divider';
                await saveSession();
            } catch (error) {
                aiContainer.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message';
                errorDiv.textContent = `Fehler: ${replaceGermanUmlauts(error.message)}`;
                chat.appendChild(errorDiv);
                chat.appendChild(document.createElement('div')).className = 'message-divider';
                console.error('Fehler beim Regenerieren:', error);
            } finally {
                isSending = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Senden';
                inputField.disabled = false;
                chat.scrollTop = chat.scrollHeight;
            }
        }

        function addFeedbackButtons(container, msgId) {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-buttons';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'feedback-btn';
            copyBtn.textContent = 'Kopieren';
            copyBtn.onclick = (e) => { e.stopPropagation(); handleCopy(msgId, copyBtn); };

            const likeBtn = document.createElement('button');
            likeBtn.className = 'feedback-btn';
            likeBtn.textContent = 'Mag ich';

            const dislikeBtn = document.createElement('button');
            dislikeBtn.className = 'feedback-btn';
            dislikeBtn.textContent = 'Mag ich gar nicht';

            likeBtn.onclick = (e) => { e.stopPropagation(); handleLike(msgId, likeBtn, dislikeBtn); };
            dislikeBtn.onclick = (e) => { e.stopPropagation(); handleDislike(msgId, likeBtn, dislikeBtn); };

            const regenBtn = document.createElement('button');
            regenBtn.className = 'feedback-btn';
            regenBtn.textContent = 'Regenerieren';
            regenBtn.onclick = (e) => { e.stopPropagation(); handleRegenerate(msgId); };

            feedbackDiv.appendChild(copyBtn);
            feedbackDiv.appendChild(likeBtn);
            feedbackDiv.appendChild(dislikeBtn);
            feedbackDiv.appendChild(regenBtn);
            container.appendChild(feedbackDiv);
        }

        async function fetchLog() {
            const logContent = document.getElementById('logContent');
            logContent.textContent = 'Lade Log-Dateien...';
            try {
                const response = await fetch(GET_LOG_URL);
                if (!response.ok) throw new Error('Fehler beim Laden');
                const text = await response.text();
                logContent.textContent = text || 'Keine Log-Einträge vorhanden';
            } catch (error) {
                logContent.textContent = 'Fehler beim Laden der Log-Datei: ' + error.message;
            }
        }
        
        async function deleteMessage(msgId) {
            if (!confirm('Diese Nachricht und alle nachfolgenden Nachrichten löschen?')) return;
            const msgIndex = contextHistory.messages.findIndex(m => m.id === msgId);
            if (msgIndex !== -1) {
                contextHistory.messages = contextHistory.messages.slice(0, msgIndex);
            }
            updateContextEstimation();
            const container = document.querySelector(`[data-msg-id="${msgId}"]`);
            if (container) {
                const elementsToRemove = [];
                let current = container;
                while (current) {
                    elementsToRemove.push(current);
                    current = current.nextElementSibling;
                }
                elementsToRemove.forEach(el => el.remove());
            }
            await saveSession();
        }
        
        function migrateSettings(oldSettings) {
            if (!oldSettings || typeof oldSettings !== 'object') {
                return { version: SETTINGS_VERSION, addressForm: 'sie', defaultMode: 'chat', noTraining: true };
            }
            return {
                version: SETTINGS_VERSION,
                addressForm: oldSettings.addressForm || 'sie',
                defaultMode: oldSettings.defaultMode || 'chat',
                noTraining: oldSettings.noTraining !== undefined ? oldSettings.noTraining : true
            };
        }
        
        let settings = { version: SETTINGS_VERSION, addressForm: 'sie', defaultMode: 'chat', noTraining: true };
        let currentMode = 'chat';
        
        const sendButton = document.getElementById('sendButton');
        const settingsButton = document.getElementById('settingsButton');
        const deepThinkButton = document.getElementById('deepThinkButton');
        const searchButton = document.getElementById('searchButton');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettingsButton = document.getElementById('saveSettings');
        const deepThinkIndicator = document.getElementById('deepThinkIndicator');
        const searchIndicator = document.getElementById('searchIndicator');
        const addressFormStatus = document.getElementById('addressFormStatus');
        const defaultModeStatus = document.getElementById('defaultModeStatus');
        const noTrainingStatus = document.getElementById('noTrainingStatus');
        const inputField = document.getElementById('input');
        const fileUpload = document.getElementById('fileUpload');
        const fileInfo = document.getElementById('fileInfo');
        const chat = document.getElementById('chat');
        const exportButton = document.getElementById('exportButton');
        const exportMenu = document.getElementById('exportMenu');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
        const exportTxtBtn = document.getElementById('exportTxtBtn');
        const exportRtfBtn = document.getElementById('exportRtfBtn');
        const loadSessionBtn = document.getElementById('loadSessionBtn');
        const sessionsOverlay = document.getElementById('sessionsOverlay');
        const closeSessions = document.getElementById('closeSessions');
        const logButton = document.getElementById('logButton');
        const logOverlay = document.getElementById('logOverlay');
        const closeLog = document.getElementById('closeLog');
        const refreshLog = document.getElementById('refreshLog');
        const noTrainingToggle = document.getElementById('noTrainingToggle');
        const noTrainingItem = document.getElementById('noTrainingItem');
        
        let selectedFile = null;
        let fileTextContent = null;
        let eventListeners = [];
        
        function addEventListenerWithCleanup(element, event, handler) {
            element.addEventListener(event, handler);
            eventListeners.push({ element, event, handler });
        }
        
        function cleanupEventListeners() {
            eventListeners.forEach(({ element, event, handler }) => {
                element.removeEventListener(event, handler);
            });
            eventListeners = [];
        }
        
        function updateInputPlaceholder() {
            inputField.placeholder = settings.addressForm === 'sie' ?
                'Ihre Nachricht hier eingeben...' : 'Deine Nachricht hier eingeben...';
        }
        
        function setMode(mode) {
            currentMode = mode;
            deepThinkButton.classList.remove('active');
            searchButton.classList.remove('active');
            deepThinkIndicator.classList.remove('mode-active');
            searchIndicator.classList.remove('mode-active');
            chat.classList.remove('thinking-mode', 'search-mode');
            if (mode === 'deepthink') {
                deepThinkButton.classList.add('active');
                deepThinkIndicator.classList.add('mode-active');
                chat.classList.add('thinking-mode');
            } else if (mode === 'search') {
                searchButton.classList.add('active');
                searchIndicator.classList.add('mode-active');
                chat.classList.add('search-mode');
            }
        }
        
        function loadSettings() {
            try {
                const savedData = localStorage.getItem('deepseekSettings');
                if (savedData) {
                    const parsedSettings = JSON.parse(savedData);
                    settings = migrateSettings(parsedSettings);
                    updateSettingsUI();
                    setMode(settings.defaultMode);
                    updateInputPlaceholder();
                }
            } catch (e) {
                console.error('Fehler beim Laden der Einstellungen:', e);
                settings = { version: SETTINGS_VERSION, addressForm: 'sie', defaultMode: 'chat', noTraining: true };
            }
        }
        
        function saveSettings() {
            settings.version = SETTINGS_VERSION;
            localStorage.setItem('deepseekSettings', JSON.stringify(settings));
            saveSettingsButton.textContent = 'Gespeichert!';
            setTimeout(() => saveSettingsButton.textContent = 'Einstellungen übernehmen', 1500);
        }
        
        function updateSettingsUI() {
            document.getElementById('sieForm').checked = (settings.addressForm === 'sie');
            document.getElementById('duForm').checked = (settings.addressForm === 'du');
            document.getElementById('chatMode').checked = (settings.defaultMode === 'chat');
            document.getElementById('deepthinkMode').checked = (settings.defaultMode === 'deepthink');
            document.getElementById('searchMode').checked = (settings.defaultMode === 'search');
            noTrainingToggle.checked = (settings.noTraining !== false);
            addressFormStatus.textContent = settings.addressForm === 'sie' ? 'Sie-Form' : 'Du-Form';
            defaultModeStatus.textContent =
                settings.defaultMode === 'chat' ? 'Normaler Chat' :
                settings.defaultMode === 'deepthink' ? 'DeepThink Modus' : 'Search Modus';
            noTrainingStatus.textContent = settings.noTraining !== false ? 'Aktiv' : 'Inaktiv';
            document.querySelectorAll('.setting-item').forEach(item => item.classList.remove('active'));
            if (settings.addressForm === 'sie') document.getElementById('sieFormItem').classList.add('active');
            else document.getElementById('duFormItem').classList.add('active');
            if (settings.defaultMode === 'chat') document.getElementById('chatModeItem').classList.add('active');
            else if (settings.defaultMode === 'deepthink') document.getElementById('deepthinkModeItem').classList.add('active');
            else document.getElementById('searchModeItem').classList.add('active');
            if (settings.noTraining !== false) {
                noTrainingItem.classList.add('toggle-active');
            } else {
                noTrainingItem.classList.remove('toggle-active');
            }
            // Anredeform in Datenschutz-Beschreibung anpassen
            const noTrainingDesc = document.getElementById('noTrainingDescription');
            if (noTrainingDesc) {
                const daten = settings.addressForm === 'sie' ? 'Ihre Daten' : 'Deine Daten';
                noTrainingDesc.innerHTML = `Sendet den Header X-No-Training: true an die API.<br>
                        Soweit von der API unterstützt werden ${daten} nicht für das Training verwendet.<br>
                        Standard: Eingeschaltet (Opt-Out aktiv).`;
            }
            // KORREKTUR: Anredeform in settings-info Text anpassen
            const settingsInfoText = document.getElementById('settingsInfoText');
            if (settingsInfoText) {
                settingsInfoText.textContent = settings.addressForm === 'sie' ?
                    'Ihre Einstellungen werden lokal in Ihrem Browser gespeichert und bleiben auch nach dem Schließen der Seite erhalten.' :
                    'Deine Einstellungen werden lokal in deinem Browser gespeichert und bleiben auch nach dem Schließen der Seite erhalten.';
            }
        }
        
        async function sendMessage() {
            if (isSending) return;
            const message = inputField.value.trim();
            if (!message && !fileTextContent) return;
            
            isSending = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Wird gesendet...';
            inputField.disabled = true;
            
            let userMessage = message;
            if (fileTextContent) userMessage = `Datei-Inhalt:\n${fileTextContent}\n\nFrage: ${message}`;
            const hasFile = !!fileTextContent;
            const msgId = addUserMessageToContext(userMessage, currentMode, hasFile);
            addMessageToChat(message, true, msgId, currentMode);
            inputField.value = '';
            
            let systemPrompt = settings.addressForm === 'sie' ?
                'Sie sind ein hilfreicher Assistent. Verwenden Sie in allen Antworten konsequent die Sie-Form.' :
                'Du bist ein hilfreicher Assistent. Verwende in allen Antworten konsequent die Du-Form.';
            if (currentMode === 'deepthink') systemPrompt += settings.addressForm === 'sie' ?
                ' Bitte geben Sie eine tiefgehende Analyse mit detaillierten Überlegungen.' :
                ' Bitte gib eine tiefgehende Analyse mit detaillierten Überlegungen.';
            else if (currentMode === 'search') systemPrompt += settings.addressForm === 'sie' ?
                ' Bitte geben Sie eine recherchierte Antwort mit aktuellen Informationen.' :
                ' Bitte gib eine recherchierte Antwort mit aktuellen Informationen.';
            updateSystemPromptTokens(systemPrompt);
            const processedSystem = replaceGermanUmlauts(systemPrompt);
            
            const aiContainer = document.createElement('div');
            aiContainer.className = 'message-container';
            const aiText = document.createElement('div');
            aiText.className = 'ai-message';
            aiText.textContent = '';
            aiContainer.appendChild(aiText);
            chat.appendChild(aiContainer);
            chat.scrollTop = chat.scrollHeight;
            
            try {
                const messages = [{ role: 'system', content: processedSystem }];
                contextHistory.messages.forEach(msg => {
                    messages.push({ role: msg.role, content: replaceGermanUmlauts(msg.content) });
                });
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        model: 'deepseek-chat', 
                        messages, 
                        max_tokens: 2000,
                        no_training: settings.noTraining
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API-Fehler (${response.status})`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, {stream: true});
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6).trim();
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                if (data.choices && data.choices[0] && data.choices[0].delta) {
                                    const token = data.choices[0].delta.content || '';
                                    if (token) {
                                        fullText += token;
                                        aiText.textContent = fullText;
                                        chat.scrollTop = chat.scrollHeight;
                                    }
                                }
                            } catch (e) {
                                // Ignoriere Parse-Fehler
                            }
                        }
                    }
                }
                
                const aiMsgId = addAIResponseToContext(fullText, currentMode);
                aiContainer.setAttribute('data-msg-id', aiMsgId);
                addFeedbackButtons(aiContainer, aiMsgId);
                
                const dlBtn = document.createElement('button');
                dlBtn.className = 'download-message-btn';
                dlBtn.textContent = ' Exportieren';
                dlBtn.onclick = (e) => { e.stopPropagation(); showSingleExportDropdown(aiMsgId, dlBtn); };
                aiContainer.appendChild(dlBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-message-btn';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => deleteMessage(aiMsgId);
                aiContainer.appendChild(deleteBtn);
                
                chat.appendChild(document.createElement('div')).className = 'message-divider';
                await saveSession();
                
            } catch (error) {
                aiContainer.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message';
                errorDiv.textContent = `Fehler: ${replaceGermanUmlauts(error.message)}`;
                chat.appendChild(errorDiv);
                chat.appendChild(document.createElement('div')).className = 'message-divider';
                console.error('Fehler beim Senden:', error);
            } finally {
                isSending = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Senden';
                inputField.disabled = false;
                chat.scrollTop = chat.scrollHeight;
            }
        }
        
        function addMessageToChat(text, isUser, msgId, mode) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            messageContainer.setAttribute('data-msg-id', msgId);
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'ai-message';
            messageDiv.textContent = text;
            messageContainer.appendChild(messageDiv);
            if (!isUser) {
                addFeedbackButtons(messageContainer, msgId);
            }
            const dlBtn = document.createElement('button');
            dlBtn.className = 'download-message-btn';
            dlBtn.textContent = ' Exportieren ';
            dlBtn.onclick = (e) => { e.stopPropagation(); showSingleExportDropdown(msgId, dlBtn); };
            messageContainer.appendChild(dlBtn);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-message-btn';
            deleteBtn.textContent = 'X';
            deleteBtn.onclick = () => deleteMessage(msgId);
            messageContainer.appendChild(deleteBtn);
            chat.appendChild(messageContainer);
            if (isUser) chat.appendChild(document.createElement('div')).className = 'message-divider';
            chat.scrollTop = chat.scrollHeight;
        }
        
        // =====================================================================
        // MAGIC BYTES SIGNATUREN fuer ausfuehrbare Dateien
        // Erkennt: Windows 32/64 Bit, Linux 32/64 Bit, macOS 32/64 Bit,
        //          ARM 32/64 Bit, Shell Scripts, Java Bytecode, Python Bytecode
        // =====================================================================
        const EXECUTABLE_SIGNATURES = [
            { bytes: [0x4D, 0x5A],                                                                                                                         platform: "Windows 32/64 Bit",        format: "PE/MZ Executable" },
            { bytes: [0x7F, 0x45, 0x4C, 0x46, 0x01],                                                                                                      platform: "Linux 32 Bit",             format: "ELF32 Executable" },
            { bytes: [0x7F, 0x45, 0x4C, 0x46, 0x02],                                                                                                      platform: "Linux 64 Bit",             format: "ELF64 Executable" },
            { bytes: [0x7F,0x45,0x4C,0x46,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x28,0x00],                               platform: "ARM 32 Bit",               format: "ELF32 ARM Executable" },
            { bytes: [0x7F,0x45,0x4C,0x46,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0xB7,0x00],                               platform: "ARM 64 Bit (AArch64)",     format: "ELF64 AArch64 Executable" },
            { bytes: [0xCE, 0xFA, 0xED, 0xFE],                                                                                                             platform: "macOS 32 Bit",             format: "Mach-O 32 Bit Executable" },
            { bytes: [0xCF, 0xFA, 0xED, 0xFE],                                                                                                             platform: "macOS 64 Bit",             format: "Mach-O 64 Bit Executable" },
            { bytes: [0xCA, 0xFE, 0xBA, 0xBE],                                                                                                             platform: "macOS Universal Binary",   format: "Mach-O Fat Binary" },
            { bytes: [0xFE, 0xED, 0xFA, 0xCE],                                                                                                             platform: "macOS/iOS ARM 32 Bit",     format: "Mach-O 32 Bit Big Endian" },
            { bytes: [0xFE, 0xED, 0xFA, 0xCF],                                                                                                             platform: "macOS/iOS ARM 64 Bit",     format: "Mach-O 64 Bit Big Endian" },
            { bytes: [0x23, 0x21],                                                                                                                         platform: "Linux/macOS/Unix",         format: "Shell Script (#!)" },
            { bytes: [0x55, 0x0D, 0x0D, 0x0A],                                                                                                            platform: "Python (plattformunabh.)", format: "Python Bytecode (.pyc)" },
        ];

        async function checkMagicBytes(file) {
            const buffer = await file.slice(0, 20).arrayBuffer();
            const bytes = new Uint8Array(buffer);
            for (const sig of EXECUTABLE_SIGNATURES) {
                const sigLen = sig.bytes.length;
                if (bytes.length < sigLen) continue;
                let match = true;
                for (let i = 0; i < sigLen; i++) {
                    if (bytes[i] !== sig.bytes[i]) { match = false; break; }
                }
                if (match) return sig;
            }
            return null;
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            selectedFile = file;
            fileTextContent = null;
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!ACCEPTED_FILE_FORMATS.includes(fileExtension)) {
                alert(`Format nicht unterstützt: ${fileExtension}\n\nUnterstützte Formate:\n${ACCEPTED_FILE_FORMATS.join(', ')}`);
                selectedFile = null;
                fileUpload.value = '';
                return;
            }
            const execSig = await checkMagicBytes(file);
            if (execSig) {
                fileInfo.innerHTML = `<div class="pdf-error">Sicherheitsfehler: Ausführbare Datei erkannt!<br>Datei: ${file.name}<br>Plattform: ${execSig.platform}<br>Format: ${execSig.format}<br>Upload wurde blockiert.</div>`;
                fileInfo.classList.add('visible');
                selectedFile = null;
                fileUpload.value = '';
                return;
            }
            const isProcessable = SUPPORTED_FILE_FORMATS.includes(fileExtension);
            if (!isProcessable) {
                fileInfo.innerHTML = `<div class="pdf-processing">Datei: ${file.name} - Format wird akzeptiert, aber nicht verarbeitet.</div><button id="removeFile">Entfernen</button>`;
                fileInfo.classList.add('visible');
                const removeBtn = document.getElementById('removeFile');
                if (removeBtn) {
                    const removeHandler = function() {
                        selectedFile = null; fileTextContent = null;
                        fileInfo.innerHTML = ''; fileInfo.classList.remove('visible');
                        fileUpload.value = ''; removeBtn.removeEventListener('click', removeHandler);
                    };
                    removeBtn.addEventListener('click', removeHandler);
                    eventListeners.push({ element: removeBtn, event: 'click', handler: removeHandler });
                }
                return;
            }
            fileInfo.innerHTML = `Datei: ${file.name} (${(file.size / 1024).toFixed(2)} KB) <button id="removeFile">Entfernen</button>`;
            fileInfo.classList.add('visible');
            try {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    fileTextContent = await extractTextFromPDF(file);
                    fileInfo.innerHTML = `Datei: ${file.name} - PDF verarbeitet (${fileTextContent.length} Zeichen) <button id="removeFile">Entfernen</button>`;
                } else if (file.type.startsWith('text/') || file.name.toLowerCase().endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        fileTextContent = e.target.result;
                        if (fileTextContent.length > MAX_FILE_CONTENT_LENGTH) fileTextContent = fileTextContent.substring(0, MAX_FILE_CONTENT_LENGTH);
                        fileInfo.innerHTML = `Datei: ${file.name} - Textdatei geladen (${fileTextContent.length} Zeichen) <button id="removeFile">Entfernen</button>`;
                    };
                    reader.readAsText(file);
                }
            } catch (error) {
                fileInfo.innerHTML = `<div class="pdf-error">Fehler: ${replaceGermanUmlauts(error.message)}</div>`;
            }
            const removeBtn = document.getElementById('removeFile');
            if (removeBtn) {
                const removeHandler = function() {
                    selectedFile = null; fileTextContent = null;
                    fileInfo.innerHTML = ''; fileInfo.classList.remove('visible');
                    fileUpload.value = ''; removeBtn.removeEventListener('click', removeHandler);
                };
                removeBtn.addEventListener('click', removeHandler);
                eventListeners.push({ element: removeBtn, event: 'click', handler: removeHandler });
            }
        }
        
        function initializeEventListeners() {
            cleanupEventListeners();
            addEventListenerWithCleanup(sendButton, 'click', sendMessage);
            addEventListenerWithCleanup(inputField, 'keydown', e => {
                if (e.key === 'Enter') {
                    if (isSending) { e.preventDefault(); return; }
                    e.preventDefault();
                    sendMessage();
                }
            });
            addEventListenerWithCleanup(fileUpload, 'change', handleFileUpload);
            addEventListenerWithCleanup(settingsButton, 'click', () => settingsOverlay.style.display = 'flex');
            addEventListenerWithCleanup(closeSettings, 'click', () => settingsOverlay.style.display = 'none');
            addEventListenerWithCleanup(exportButton, 'click', () => exportMenu.classList.toggle('show'));
            addEventListenerWithCleanup(exportPdfBtn, 'click', () => { exportMenu.classList.remove('show'); exportPDF(); });
            addEventListenerWithCleanup(exportMarkdownBtn, 'click', () => { exportMenu.classList.remove('show'); exportMarkdown(); });
            addEventListenerWithCleanup(exportTxtBtn, 'click', () => { exportMenu.classList.remove('show'); exportTxt(); });
            addEventListenerWithCleanup(exportRtfBtn, 'click', () => { exportMenu.classList.remove('show'); exportRtf(); });
            addEventListenerWithCleanup(loadSessionBtn, 'click', async () => {
                exportMenu.classList.remove('show');
                await loadSessionsList();
                sessionsOverlay.style.display = 'flex';
            });
            addEventListenerWithCleanup(closeSessions, 'click', () => sessionsOverlay.style.display = 'none');
            addEventListenerWithCleanup(logButton, 'click', async () => {
                logOverlay.style.display = 'flex';
                await fetchLog();
            });
            addEventListenerWithCleanup(closeLog, 'click', () => logOverlay.style.display = 'none');
            addEventListenerWithCleanup(refreshLog, 'click', fetchLog);
            addEventListenerWithCleanup(document, 'click', (e) => {
                if (!exportButton.contains(e.target) && !exportMenu.contains(e.target)) {
                    exportMenu.classList.remove('show');
                }
                if (activeSingleExportDropdown && !activeSingleExportDropdown.contains(e.target)) {
                    activeSingleExportDropdown.classList.remove('show');
                    activeSingleExportDropdown = null;
                }
            });
            addEventListenerWithCleanup(document, 'keydown', (e) => {
                if (e.key === 'Escape') {
                    logOverlay.style.display = 'none';
                    sessionsOverlay.style.display = 'none';
                    settingsOverlay.style.display = 'none';
                    exportMenu.classList.remove('show');
                    if (activeSingleExportDropdown) {
                        activeSingleExportDropdown.classList.remove('show');
                        activeSingleExportDropdown = null;
                    }
                }
            });
            addEventListenerWithCleanup(noTrainingToggle, 'change', () => {
                noTrainingStatus.textContent = noTrainingToggle.checked ? 'Aktiv' : 'Inaktiv';
                if (noTrainingToggle.checked) {
                    noTrainingItem.classList.add('toggle-active');
                } else {
                    noTrainingItem.classList.remove('toggle-active');
                }
            });
            // BUGFIX 3: updateSettingsUI() nach dem Speichern aufrufen
            // damit Datenschutz-Beschreibung die neue Anredeform sofort anzeigt
            const saveHandler = function() {
                settings.addressForm = document.querySelector('input[name="addressForm"]:checked').value;
                settings.defaultMode = document.querySelector('input[name="defaultMode"]:checked').value;
                settings.noTraining = noTrainingToggle.checked;
                saveSettings();
                setMode(settings.defaultMode);
                updateInputPlaceholder();
                updateSettingsUI();
                settingsOverlay.style.display = 'none';
            };
            addEventListenerWithCleanup(saveSettingsButton, 'click', saveHandler);
            const deepThinkHandler = () => setMode(currentMode === 'deepthink' ? 'chat' : 'deepthink');
            const searchHandler = () => setMode(currentMode === 'search' ? 'chat' : 'search');
            addEventListenerWithCleanup(deepThinkButton, 'click', deepThinkHandler);
            addEventListenerWithCleanup(searchButton, 'click', searchHandler);
            document.querySelectorAll('.setting-item').forEach(item => {
                const clickHandler = function() {
                    const radioInput = this.querySelector('input[type="radio"]');
                    if (radioInput) {
                        radioInput.checked = true;
                        document.querySelectorAll('.setting-item').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                    }
                };
                addEventListenerWithCleanup(item, 'click', clickHandler);
            });
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                const changeHandler = function() {
                    document.querySelectorAll('.setting-item').forEach(item => item.classList.remove('active'));
                    const parentItem = this.closest('.setting-item');
                    if (parentItem) parentItem.classList.add('active');
                };
                addEventListenerWithCleanup(radio, 'change', changeHandler);
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            updateServerTitle();
            loadSettings();
            initializeEventListeners();
            updateSettingsUI();
            currentSessionId = generateSessionId();
        });
        
        window.addEventListener('beforeunload', function() {
            cleanupEventListeners();
        });
    </script>
</body>
</html>


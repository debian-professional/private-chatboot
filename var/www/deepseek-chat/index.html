<!DOCTYPE html>
<html>
<head>
    <title>DeepSeek Chat</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            background: #121212;
            color: #f0f0f0;
            margin: 0;
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0056b3;
        }
        .server-title-section {
            flex: 1;
        }
        .server-title-section h1 {
            margin-top: 0;
            color: #4dabf7;
            text-align: left;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 0;
            border-bottom: none;
        }
        .server-info {
            font-size: 14px;
            color: #aaa;
            font-weight: normal;
        }
        #chat { 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #444; 
            padding: 10px; 
            margin-bottom: 10px; 
            background: #1e1e1e;
            color: #f0f0f0;
            line-height: 1.5;
        }
        .user-message {
            color: #4dabf7;
            margin-bottom: 5px;
        }
        .ai-message {
            color: #f0f0f0;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        .message-divider {
            height: 1px;
            background: #444;
            margin: 10px 0;
            opacity: 0.5;
        }
        .thinking-mode {
            background: #1a1a2e !important;
            border-left: 4px solid #28a745 !important;
        }
        .search-mode {
            background: #1a1a2e !important;
            border-left: 4px solid #17a2b8 !important;
        }
        #input { 
            width: 100%;
            padding: 10px; 
            background: #2d2d2d;
            color: #f0f0f0;
            border: 1px solid #444;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .buttons-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
            height: 40px;
        }
        .action-button { 
            padding: 10px 20px; 
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            margin: 0 5px;
        }
        .action-button:hover {
            background: #003d82;
        }
        .action-button:disabled {
            background: #444;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .mode-button {
            padding: 10px 20px; 
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            margin: 0 5px;
        }
        .mode-button:hover {
            background: #218838;
        }
        .mode-button.active {
            background: #155724;
            box-shadow: 0 0 0 2px #fff;
        }
        .mode-button.search-mode-btn {
            background: #17a2b8;
        }
        .mode-button.search-mode-btn:hover {
            background: #138496;
        }
        .mode-button.search-mode-btn.active {
            background: #0c5460;
        }
        .log-button-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
            height: 40px;
            justify-content: center;
        }
        .log-button {
            padding: 10px 20px;
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            margin: 0 auto;
        }
        .log-button:hover {
            background: #003d82;
        }
        .file-input-wrapper {
            position: relative;
            flex: 1;
            height: 40px;
        }
        #fileUpload {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .mode-indicator {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            display: none;
        }
        .deepthink-indicator {
            background: #155724;
            color: #90ee90;
            border-left: 4px solid #28a745;
        }
        .search-indicator {
            background: #0c5460;
            color: #a6e3ff;
            border-left: 4px solid #17a2b8;
        }
        .mode-active {
            display: block;
        }
        #fileInfo {
            margin: 10px 0;
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            display: none;
        }
        #fileInfo.visible {
            display: block;
        }
        #removeFile {
            background: #dc3545;
            margin-left: 10px;
            padding: 4px 8px;
            font-size: 12px;
        }
        #removeFile:hover {
            background: #c82333;
        }
        .pdf-processing {
            padding: 10px;
            background: #155724;
            color: #90ee90;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .pdf-error {
            padding: 10px;
            background: #721c24;
            color: #f8d7da;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .pdf-progress {
            height: 4px;
            background: #444;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .pdf-progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }
        .token-warning {
            padding: 8px;
            margin: 10px 0;
            background: #856404;
            color: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        .token-warning.visible {
            display: block;
        }
        .token-info {
            padding: 5px 10px;
            margin: 5px 0;
            background: #2d2d2d;
            color: #aaa;
            border-radius: 4px;
            font-size: 12px;
            text-align: right;
        }
        #settingsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        #settingsPanel {
            background: #1e1e1e;
            border: 2px solid #0056b3;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0056b3;
        }
        .settings-title {
            font-size: 22px;
            font-weight: bold;
            color: #4dabf7;
        }
        .close-settings {
            background: #dc3545;
            border: none;
            color: white;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-settings:hover {
            background: #c82333;
        }
        .settings-group {
            margin-bottom: 25px;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border-left: none;
        }
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .group-title {
            font-size: 16px;
            color: #f0f0f0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .group-status {
            font-size: 12px;
            color: #aaa;
            font-style: italic;
        }
        .setting-item {
            margin: 12px 0;
            padding: 12px;
            background: #2d2d2d;
            border-radius: 6px;
            border: 1px solid #333;
            transition: all 0.2s;
        }
        .setting-item:hover {
            background: #333;
            border-color: #444;
        }
        .setting-item.active {
            background: #1e3a5f;
            border-color: #0056b3;
        }
        .setting-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .setting-name {
            font-size: 15px;
            color: #f0f0f0;
            font-weight: normal;
        }
        .setting-description {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
            line-height: 1.4;
            padding-left: 20px;
        }
        .radio-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #666;
            border-radius: 50%;
            position: relative;
            transition: all 0.2s;
        }
        .setting-label input[type="radio"] {
            display: none;
        }
        .setting-label input[type="radio"]:checked + .radio-custom {
            border-color: #4dabf7;
            background-color: #4dabf7;
        }
        .setting-label input[type="radio"]:checked + .radio-custom::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }
        .settings-info {
            margin-top: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .info-title {
            font-size: 14px;
            color: #90ee90;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .info-text {
            font-size: 12px;
            color: #aaa;
            line-height: 1.4;
        }
        .save-button {
            width: 100%;
            padding: 14px;
            background: #0056b3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 25px;
            transition: background 0.3s;
        }
        .save-button:hover {
            background: #003d82;
        }

        /* Log-Overlay Styles */
        #logOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1002;
            align-items: center;
            justify-content: center;
        }
        #logPanel {
            background: #1e1e1e;
            border: 2px solid #0056b3;
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0056b3;
        }
        .log-title {
            font-size: 22px;
            font-weight: bold;
            color: #4dabf7;
        }
        .log-header-buttons {
            display: flex;
            gap: 10px;
        }
        .log-refresh-button {
            background: #28a745;
            border: none;
            color: white;
            font-size: 14px;
            width: auto;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
        }
        .log-refresh-button:hover {
            background: #218838;
        }
        .close-log {
            background: #dc3545;
            border: none;
            color: white;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-log:hover {
            background: #c82333;
        }
        #logContent {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            overflow-y: auto;
            font-family: Consolas, Monaco, 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #f0f0f0;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 300px;
            max-height: calc(80vh - 120px);
        }
        .log-empty {
            color: #aaa;
            font-style: italic;
            text-align: center;
            padding: 50px 0;
        }
        .log-error {
            color: #f8d7da;
            background: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="server-header">
        <div class="server-title-section">
            <h1 id="serverTitle">DeepSeek Chat Server</h1>
            <div class="server-info" id="serverInfo">IP: Lade Server-Informationen...</div>
        </div>
    </div>
    
    <div id="chat"></div>
    
    <input type="text" id="input" placeholder="Ihre Nachricht hier eingeben...">
    
    <div id="tokenInfo" class="token-info"></div>
    <div id="tokenWarning" class="token-warning"></div>
    
    <div id="deepThinkIndicator" class="mode-indicator deepthink-indicator">
        DeepThink Modus aktiv: Tiefgehende Analyse wird durchgefuehrt
    </div>
    <div id="searchIndicator" class="mode-indicator search-indicator">
        Search Modus aktiv: Internet-Recherche wird durchgefuehrt
    </div>
    
    <div class="buttons-row">
        <button id="sendButton" class="action-button">Senden</button>
        <div class="file-input-wrapper">
            <button id="uploadButton" class="action-button">Datei hochladen</button>
            <input type="file" id="fileUpload" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.csv,.xlsx,.pptx">
        </div>
        <button id="settingsButton" class="action-button">Einstellungen</button>
    </div>
    
    <div class="buttons-row">
        <button id="deepThinkButton" class="mode-button">DeepThink</button>
        <button id="searchButton" class="mode-button search-mode-btn">Search</button>
    </div>

    <!-- Neue Button-Reihe für Log-Dateien -->
    <div class="log-button-row">
        <button id="logButton" class="log-button">Log-Dateien</button>
    </div>
    
    <div id="fileInfo"></div>
    
    <div id="settingsOverlay">
        <div id="settingsPanel">
            <div class="settings-header">
                <div class="settings-title">Chat Einstellungen</div>
                <button class="close-settings" id="closeSettings" title="Schliessen">&times;</button>
            </div>
            
            <div class="settings-group">
                <div class="group-header">
                    <div class="group-title">Anredeform</div>
                    <div class="group-status" id="addressFormStatus">Sie-Form</div>
                </div>
                
                <div class="setting-item" id="sieFormItem">
                    <label class="setting-label" for="sieForm">
                        <span class="setting-name">Sie-Form (formell)</span>
                        <input type="radio" name="addressForm" id="sieForm" value="sie" checked>
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Sie werden mit der formellen Anrede "Sie" angesprochen.
                    </div>
                </div>
                
                <div class="setting-item" id="duFormItem">
                    <label class="setting-label" for="duForm">
                        <span class="setting-name">Du-Form (informell)</span>
                        <input type="radio" name="addressForm" id="duForm" value="du">
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Du wirst mit der informellen Anrede "Du" angesprochen.
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="group-header">
                    <div class="group-title">Standard Modus</div>
                    <div class="group-status" id="defaultModeStatus">Normaler Chat</div>
                </div>
                
                <div class="setting-item" id="chatModeItem">
                    <label class="setting-label" for="chatMode">
                        <span class="setting-name">Normaler Chat</span>
                        <input type="radio" name="defaultMode" id="chatMode" value="chat" checked>
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Standard-Gespraechsmodus fuer allgemeine Fragen.
                    </div>
                </div>
                
                <div class="setting-item" id="deepthinkModeItem">
                    <label class="setting-label" for="deepthinkMode">
                        <span class="setting-name">DeepThink Modus</span>
                        <input type="radio" name="defaultMode" id="deepthinkMode" value="deepthink">
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Tiefgehende Analyse mit detaillierten Ueberlegungen.
                    </div>
                </div>
                
                <div class="setting-item" id="searchModeItem">
                    <label class="setting-label" for="searchMode">
                        <span class="setting-name">Search Modus</span>
                        <input type="radio" name="defaultMode" id="searchMode" value="search">
                        <span class="radio-custom"></span>
                    </label>
                    <div class="setting-description">
                        Recherche-basierte Antworten mit aktuellen Informationen.
                    </div>
                </div>
            </div>
            
            <div class="settings-info">
                <div class="info-title">Einstellungen werden automatisch gespeichert</div>
                <div class="info-text">
                    Ihre Einstellungen werden lokal in Ihrem Browser gespeichert und bleiben auch nach dem Schliessen der Seite erhalten.
                </div>
            </div>
            
            <button class="save-button" id="saveSettings">
                 Einstellungen uebernehmen
            </button>
        </div>
    </div>

    <!-- Log Overlay -->
    <div id="logOverlay">
        <div id="logPanel">
            <div class="log-header">
                <div class="log-title">Server-Log</div>
                <div class="log-header-buttons">
                    <button class="log-refresh-button" id="refreshLog">Aktualisieren</button>
                    <button class="close-log" id="closeLog" title="Schliessen">&times;</button>
                </div>
            </div>
            <div id="logContent">
                <div class="log-empty">Log wird geladen...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/chat';
        const LOG_API_URL = '/cgi-bin/get-log.py';
        const SERVER_NAME = 'DeepSeek Chat Server';
        const MAX_CONTEXT_TOKENS = 128000;
        const MAX_CONTEXT_MESSAGES = 20;
        // Verbesserte Token-Schätzung: 1 Token ≈ 4 Zeichen für Deutsch (genauer als 0.25)
        // Basierend auf typischen Tokenizer-Verhältnissen für europäische Sprachen
        const CHARS_PER_TOKEN = 4;
        const TOKENS_PER_CHAR = 1 / CHARS_PER_TOKEN;
        const MAX_FILE_CONTENT_LENGTH = 15000;
        const MAX_FILE_SIZE_MB = 10;
        const PDF_EXTRACTION_TIMEOUT = 30000;
        const SETTINGS_VERSION = '1.0';
        const SUPPORTED_FILE_FORMATS = ['.txt', '.pdf'];
        const ACCEPTED_FILE_FORMATS = ['.txt', '.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.csv', '.xlsx', '.pptx'];
        
        let isSending = false;
        let lastApiResponse = null; // Speichert die letzte API-Antwort für Token-Informationen
        
        function replaceGermanUmlauts(text) {
            if (!text) return text;
            return text
                 .replace(/ä/g, "ae").replace(/ö/g, "oe").replace(/ü/g, "ue").replace(/ß/g, "ss")
                 .replace(/Ä/g, "Ae").replace(/Ö/g, "Oe").replace(/Ü/g, "Ue");
        }
        
        async function loadPDFJSWorker() {
            const cdnUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js',
                'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
            ];
            
            for (const url of cdnUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (response.ok) {
                        return url;
                    }
                } catch (error) {
                    console.log(`CDN ${url} nicht erreichbar, versuche nächste...`);
                }
            }
            
            console.warn('Kein PDF.js Worker verfügbar, PDF-Extraktion wird eingeschränkt funktionieren');
            return null;
        }
        
        async function extractTextFromPDF(file) {
            return new Promise(async (resolve, reject) => {
                let timeoutId;
                
                try {
                    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                        throw new Error(`Datei zu groß. Maximale Größe: ${MAX_FILE_SIZE_MB} MB`);
                    }
                    
                    const workerUrl = await loadPDFJSWorker();
                    if (workerUrl) {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
                    }
                    
                    const loadingTask = pdfjsLib.getDocument({ data: await file.arrayBuffer() });
                    const pdf = await loadingTask.promise;
                    let fullText = '';
                    const totalPages = pdf.numPages;
                    const progressInfo = document.getElementById('fileInfo');
                    
                    timeoutId = setTimeout(() => {
                        reject(new Error('PDF-Extraktion hat zu lange gedauert. Bitte versuchen Sie eine kleinere Datei.'));
                    }, PDF_EXTRACTION_TIMEOUT);
                    
                    for (let i = 1; i <= totalPages && fullText.length < MAX_FILE_CONTENT_LENGTH; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ') + '\n\n';
                        
                        if (fullText.length + pageText.length > MAX_FILE_CONTENT_LENGTH) {
                            const remainingChars = MAX_FILE_CONTENT_LENGTH - fullText.length;
                            if (remainingChars > 0) {
                                fullText += pageText.substring(0, remainingChars);
                            }
                            break;
                        } else {
                            fullText += pageText;
                        }
                        
                        if (progressInfo) {
                            const progress = Math.round((i / totalPages) * 100);
                            progressInfo.innerHTML = `
                                <div class="pdf-processing">
                                    PDF wird verarbeitet: Seite ${i}/${totalPages}
                                    <div class="pdf-progress">
                                        <div class="pdf-progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                </div>`;
                        }
                    }
                    
                    clearTimeout(timeoutId);
                    
                    if (fullText.length > MAX_FILE_CONTENT_LENGTH) {
                        fullText = fullText.substring(0, MAX_FILE_CONTENT_LENGTH);
                    }
                    
                    resolve(fullText);
                } catch (error) {
                    if (timeoutId) clearTimeout(timeoutId);
                    reject(new Error(`PDF-Extraktion fehlgeschlagen: ${error.message}`));
                }
            });
        }
        
        function getServerIP() {
            try {
                const hostname = window.location.hostname;
                if (!hostname || hostname === 'localhost' || hostname === '127.0.0.1') return 'localhost';
                return hostname;
            } catch (error) {
                console.error('Fehler beim Ermitteln der Server-IP:', error);
                return 'Unbekannt';
            }
        }
        
        function updateServerTitle() {
            document.getElementById('serverTitle').textContent = SERVER_NAME;
            document.getElementById('serverInfo').textContent = `IP: ${getServerIP()}`;
        }
        
        let contextHistory = {
            systemPromptTokens: 0,
            messages: [],  // {role: "user"|"assistant", content: "..."} – chronologisch (älteste zuerst)
            totalEstimatedTokens: 0,
            actualTokens: 0 // Wird aus API-Responses aktualisiert
        };
        
        // Verbesserte Token-Schätzung mit Wort-basierter Heuristik
        function estimateTokens(text) {
            if (!text) return 0;
            
            // Entferne mehrfache Leerzeichen und Zeilenumbrüche für konsistente Zählung
            const normalizedText = text.replace(/\s+/g, ' ').trim();
            
            // Deutsche Sprache: Durchschnittliche Wortlänge ca. 6-8 Zeichen
            // Ein Token entspricht etwa 0.75 Wörtern oder 4-5 Zeichen
            const words = normalizedText.split(' ').length;
            const characters = normalizedText.length;
            
            // Kombinierte Schätzung: Wörter und Zeichen
            const wordBasedEstimate = Math.ceil(words * 1.3); // 1 Wort ≈ 1.3 Tokens für Deutsch
            const charBasedEstimate = Math.ceil(characters / CHARS_PER_TOKEN);
            
            // Verwende den höheren Wert als konservative Schätzung
            return Math.max(wordBasedEstimate, charBasedEstimate);
        }
        
        function updateContextEstimation() {
            let total = contextHistory.systemPromptTokens;
            contextHistory.messages.forEach(msg => total += estimateTokens(msg.content));
            contextHistory.totalEstimatedTokens = total;
            
            const tokenInfo = document.getElementById('tokenInfo');
            const tokenWarning = document.getElementById('tokenWarning');
            
            // Zeige Token-Informationen an
            if (total > 0) {
                let infoText = `Geschätzte Token: ${total}`;
                if (contextHistory.actualTokens > 0) {
                    infoText += ` | Tatsächliche Token (letzte Antwort): ${contextHistory.actualTokens}`;
                }
                infoText += ` | Maximum: ${MAX_CONTEXT_TOKENS}`;
                tokenInfo.textContent = infoText;
                
                // Warnung bei Annäherung an Limit
                if (total > MAX_CONTEXT_TOKENS * 0.8) {
                    tokenWarning.textContent = `Warnung: Kontext nähert sich dem Maximum (${total}/${MAX_CONTEXT_TOKENS}). Ältere Nachrichten werden möglicherweise gekürzt.`;
                    tokenWarning.classList.add('visible');
                } else {
                    tokenWarning.classList.remove('visible');
                }
            }
            
            return total;
        }
        
        function addUserMessageToContext(content) {
            contextHistory.messages.push({role: "user", content});
            trimContextByTokens();
            updateContextEstimation();
        }
        
        function addAIResponseToContext(content, actualTokens = null) {
            contextHistory.messages.push({role: "assistant", content});
            if (actualTokens) {
                contextHistory.actualTokens = actualTokens;
            }
            trimContextByTokens();
            updateContextEstimation();
        }
        
        function trimContextByTokens() {
            // Entferne älteste Nachrichten bis das geschätzte Token-Limit unterschritten wird
            // aber behalte mindestens die letzten 2 Nachrichten (eine User + eine AI)
            const MIN_MESSAGES = 2;
            
            while (contextHistory.messages.length > MIN_MESSAGES && 
                   updateContextEstimation() > MAX_CONTEXT_TOKENS * 0.9) { // 90% als Sicherheitspuffer
                contextHistory.messages.shift(); // Älteste Nachricht entfernen
            }
        }
        
        function updateSystemPromptTokens(prompt) {
            contextHistory.systemPromptTokens = estimateTokens(prompt);
            updateContextEstimation();
        }
        
        function migrateSettings(oldSettings) {
            if (!oldSettings || typeof oldSettings !== 'object') {
                return {
                    version: SETTINGS_VERSION,
                    addressForm: 'sie',
                    defaultMode: 'chat'
                };
            }
            
            return {
                version: SETTINGS_VERSION,
                addressForm: oldSettings.addressForm || 'sie',
                defaultMode: oldSettings.defaultMode || 'chat'
            };
        }
        
        let settings = { 
            version: SETTINGS_VERSION,
            addressForm: 'sie', 
            defaultMode: 'chat' 
        };
        
        let currentMode = 'chat';
        const sendButton = document.getElementById('sendButton');
        const settingsButton = document.getElementById('settingsButton');
        const deepThinkButton = document.getElementById('deepThinkButton');
        const searchButton = document.getElementById('searchButton');
        const logButton = document.getElementById('logButton');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettingsButton = document.getElementById('saveSettings');
        const deepThinkIndicator = document.getElementById('deepThinkIndicator');
        const searchIndicator = document.getElementById('searchIndicator');
        const addressFormStatus = document.getElementById('addressFormStatus');
        const defaultModeStatus = document.getElementById('defaultModeStatus');
        const inputField = document.getElementById('input');
        const fileUpload = document.getElementById('fileUpload');
        const fileInfo = document.getElementById('fileInfo');
        const chat = document.getElementById('chat');
        const logOverlay = document.getElementById('logOverlay');
        const logContent = document.getElementById('logContent');
        const closeLog = document.getElementById('closeLog');
        const refreshLog = document.getElementById('refreshLog');
        let selectedFile = null;
        let fileTextContent = null;
        
        let eventListeners = [];
        
        function addEventListenerWithCleanup(element, event, handler) {
            element.addEventListener(event, handler);
            eventListeners.push({ element, event, handler });
        }
        
        function cleanupEventListeners() {
            eventListeners.forEach(({ element, event, handler }) => {
                element.removeEventListener(event, handler);
            });
            eventListeners = [];
        }
        
        function updateInputPlaceholder() {
            inputField.placeholder = settings.addressForm === 'sie' ? 
                'Ihre Nachricht hier eingeben...' : 'Deine Nachricht hier eingeben...';
        }
        
        function setMode(mode) {
            currentMode = mode;
            deepThinkButton.classList.remove('active');
            searchButton.classList.remove('active');
            deepThinkIndicator.classList.remove('mode-active');
            searchIndicator.classList.remove('mode-active');
            chat.classList.remove('thinking-mode', 'search-mode');
            
            if (mode === 'deepthink') {
                deepThinkButton.classList.add('active');
                deepThinkIndicator.classList.add('mode-active');
                chat.classList.add('thinking-mode');
            } else if (mode === 'search') {
                searchButton.classList.add('active');
                searchIndicator.classList.add('mode-active');
                chat.classList.add('search-mode');
            } else {
                deepThinkButton.classList.remove('active');
                searchButton.classList.remove('active');
            }
        }
        
        function loadSettings() {
            try {
                const savedData = localStorage.getItem('deepseekSettings');
                if (savedData) {
                    const parsedSettings = JSON.parse(savedData);
                    settings = migrateSettings(parsedSettings);
                    updateSettingsUI();
                    setMode(settings.defaultMode);
                    updateInputPlaceholder();
                }
            } catch (e) {
                console.error('Fehler beim Laden der Einstellungen:', e);
                settings = { 
                    version: SETTINGS_VERSION,
                    addressForm: 'sie', 
                    defaultMode: 'chat' 
                };
            }
        }
        
        function saveSettings() {
            settings.version = SETTINGS_VERSION;
            localStorage.setItem('deepseekSettings', JSON.stringify(settings));
            saveSettingsButton.textContent = 'Gespeichert!';
            setTimeout(() => saveSettingsButton.textContent = 'Einstellungen uebernehmen', 1500);
        }
        
        function updateSettingsUI() {
            document.getElementById('sieForm').checked = (settings.addressForm === 'sie');
            document.getElementById('duForm').checked = (settings.addressForm === 'du');
            document.getElementById('chatMode').checked = (settings.defaultMode === 'chat');
            document.getElementById('deepthinkMode').checked = (settings.defaultMode === 'deepthink');
            document.getElementById('searchMode').checked = (settings.defaultMode === 'search');
            
            addressFormStatus.textContent = settings.addressForm === 'sie' ? 'Sie-Form' : 'Du-Form';
            defaultModeStatus.textContent = 
                settings.defaultMode === 'chat' ? 'Normaler Chat' :
                settings.defaultMode === 'deepthink' ? 'DeepThink Modus' : 'Search Modus';
            
            document.querySelectorAll('.setting-item').forEach(item => item.classList.remove('active'));
            if (settings.addressForm === 'sie') document.getElementById('sieFormItem').classList.add('active');
            else document.getElementById('duFormItem').classList.add('active');
            
            if (settings.defaultMode === 'chat') document.getElementById('chatModeItem').classList.add('active');
            else if (settings.defaultMode === 'deepthink') document.getElementById('deepthinkModeItem').classList.add('active');
            else document.getElementById('searchModeItem').classList.add('active');
        }
        
        async function sendMessage() {
            if (isSending) return;
            const message = inputField.value.trim();
            if (!message && !fileTextContent) return;
            
            isSending = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Wird gesendet...';
            inputField.disabled = true;
            
            let userMessage = message;
            if (fileTextContent) {
                userMessage = `Datei-Inhalt:\n${fileTextContent}\n\nFrage: ${message}`;
            }
            
            addUserMessageToContext(userMessage);
            
            addMessageToChat(message, true);
            inputField.value = '';
            
            let systemPrompt = settings.addressForm === 'sie' ?
                'Sie sind ein hilfreicher Assistent. Verwenden Sie in allen Antworten konsequent die Sie-Form.' :
                'Du bist ein hilfreicher Assistent. Verwende in allen Antworten konsequent die Du-Form.';
            
            if (currentMode === 'deepthink') systemPrompt += ' Bitte geben Sie eine tiefgehende Analyse mit detaillierten Ueberlegungen.';
            else if (currentMode === 'search') systemPrompt += ' Bitte geben Sie eine recherchierte Antwort mit aktuellen Informationen.';
            
            updateSystemPromptTokens(systemPrompt);
            
            const processedSystem = replaceGermanUmlauts(systemPrompt);
            const processedUser = replaceGermanUmlauts(userMessage);
            
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'ai-message';
            thinkingDiv.textContent = 'Denkt...';
            chat.appendChild(thinkingDiv);
            chat.scrollTop = chat.scrollHeight;
            
            try {
                const messages = [{ role: 'system', content: processedSystem }];
                
                // Chronologische Reihenfolge (älteste zuerst)
                contextHistory.messages.forEach(msg => {
                    messages.push({
                        role: msg.role,
                        content: replaceGermanUmlauts(msg.content)
                    });
                });
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: messages,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API-Fehler (${response.status}): ${errorText}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('Ungültige API-Antwort-Struktur erhalten');
                }
                
                const aiResponse = data.choices[0].message.content;
                
                // Token-Informationen aus API-Response extrahieren (falls vorhanden)
                let actualTokens = null;
                if (data.usage && data.usage.total_tokens) {
                    actualTokens = data.usage.total_tokens;
                }
                
                addAIResponseToContext(aiResponse, actualTokens);
                
                thinkingDiv.textContent = aiResponse;
                chat.appendChild(document.createElement('div')).className = 'message-divider';
                
                // Context nach der Antwort erneut trimmen basierend auf tatsächlichen Tokens
                if (actualTokens) {
                    trimContextByTokens();
                }
            } catch (error) {
                thinkingDiv.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message';
                errorDiv.textContent = `Fehler: ${replaceGermanUmlauts(error.message)}`;
                chat.appendChild(errorDiv);
                chat.appendChild(document.createElement('div')).className = 'message-divider';
                console.error('Fehler beim Senden:', error);
            } finally {
                isSending = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Senden';
                inputField.disabled = false;
                chat.scrollTop = chat.scrollHeight;
            }
        }
        
        function addMessageToChat(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'ai-message';
            messageDiv.textContent = text;
            chat.appendChild(messageDiv);
            
            if (isUser) chat.appendChild(document.createElement('div')).className = 'message-divider';
            chat.scrollTop = chat.scrollHeight;
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            fileTextContent = null;
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!ACCEPTED_FILE_FORMATS.includes(fileExtension)) {
                fileInfo.innerHTML = `<div class="pdf-error">Format nicht unterstuetzt: ${fileExtension}. Unterstuetzte Formate: ${ACCEPTED_FILE_FORMATS.join(', ')}</div>`;
                fileInfo.classList.add('visible');
                selectedFile = null;
                fileUpload.value = '';
                return;
            }
            
            const isProcessable = SUPPORTED_FILE_FORMATS.includes(fileExtension);
            
            if (!isProcessable) {
                fileInfo.innerHTML = `<div class="pdf-processing">Datei: ${file.name} - Format wird akzeptiert, aber nicht verarbeitet. Nur Dateiname wird gespeichert.</div><button id="removeFile">Entfernen</button>`;
                fileInfo.classList.add('visible');
                const removeBtn = document.getElementById('removeFile');
                if (removeBtn) {
                    const removeHandler = function() {
                        selectedFile = null;
                        fileTextContent = null;
                        fileInfo.innerHTML = '';
                        fileInfo.classList.remove('visible');
                        fileUpload.value = '';
                        removeBtn.removeEventListener('click', removeHandler);
                    };
                    removeBtn.addEventListener('click', removeHandler);
                    eventListeners.push({ element: removeBtn, event: 'click', handler: removeHandler });
                }
                return;
            }
            
            fileInfo.innerHTML = `Datei: ${file.name} (${(file.size / 1024).toFixed(2)} KB) <button id="removeFile">Entfernen</button>`;
            fileInfo.classList.add('visible');
            
            try {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    fileTextContent = await extractTextFromPDF(file);
                    fileInfo.innerHTML = `Datei: ${file.name} - PDF verarbeitet (${fileTextContent.length} Zeichen) <button id="removeFile">Entfernen</button>`;
                } else if (file.type.startsWith('text/') || file.name.toLowerCase().endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        fileTextContent = e.target.result;
                        if (fileTextContent.length > MAX_FILE_CONTENT_LENGTH) {
                            fileTextContent = fileTextContent.substring(0, MAX_FILE_CONTENT_LENGTH);
                        }
                        fileInfo.innerHTML = `Datei: ${file.name} - Textdatei geladen (${fileTextContent.length} Zeichen) <button id="removeFile">Entfernen</button>`;
                    };
                    reader.readAsText(file);
                }
            } catch (error) {
                fileInfo.innerHTML = `<div class="pdf-error">Fehler: ${replaceGermanUmlauts(error.message)}</div>`;
            }
            
            const removeBtn = document.getElementById('removeFile');
            if (removeBtn) {
                const removeHandler = function() {
                    selectedFile = null;
                    fileTextContent = null;
                    fileInfo.innerHTML = '';
                    fileInfo.classList.remove('visible');
                    fileUpload.value = '';
                    removeBtn.removeEventListener('click', removeHandler);
                };
                removeBtn.addEventListener('click', removeHandler);
                eventListeners.push({ element: removeBtn, event: 'click', handler: removeHandler });
            }
        }

        // Log-Funktionen
        async function loadLogContent() {
            try {
                logContent.innerHTML = '<div class="log-empty">Log wird geladen...</div>';
                
                const response = await fetch(LOG_API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP-Fehler ${response.status}`);
                }
                
                const logText = await response.text();
                
                if (!logText || logText.trim() === '') {
                    logContent.innerHTML = '<div class="log-empty">Keine Log-Einträge vorhanden</div>';
                } else {
                    logContent.textContent = logText;
                }
            } catch (error) {
                console.error('Fehler beim Laden des Logs:', error);
                logContent.innerHTML = `<div class="log-error">Fehler beim Laden des Logs: ${replaceGermanUmlauts(error.message)}</div>`;
            }
        }

        function toggleLogOverlay() {
            if (logOverlay.style.display === 'flex') {
                logOverlay.style.display = 'none';
            } else {
                logOverlay.style.display = 'flex';
                loadLogContent();
            }
        }
        
        function initializeEventListeners() {
            cleanupEventListeners();
            
            addEventListenerWithCleanup(sendButton, 'click', sendMessage);
            addEventListenerWithCleanup(inputField, 'keydown', e => { 
                if (e.key === 'Enter') {
                    if (isSending) {
                        e.preventDefault();
                        return;
                    }
                    e.preventDefault();
                    sendMessage(); 
                }
            });
            addEventListenerWithCleanup(fileUpload, 'change', handleFileUpload);
            addEventListenerWithCleanup(settingsButton, 'click', () => settingsOverlay.style.display = 'flex');
            addEventListenerWithCleanup(closeSettings, 'click', () => settingsOverlay.style.display = 'none');
            
            const saveHandler = function() {
                settings.addressForm = document.querySelector('input[name="addressForm"]:checked').value;
                settings.defaultMode = document.querySelector('input[name="defaultMode"]:checked').value;
                saveSettings();
                setMode(settings.defaultMode);
                updateInputPlaceholder();
                settingsOverlay.style.display = 'none';
            };
            addEventListenerWithCleanup(saveSettingsButton, 'click', saveHandler);
            
            const deepThinkHandler = () => setMode(currentMode === 'deepthink' ? 'chat' : 'deepthink');
            const searchHandler = () => setMode(currentMode === 'search' ? 'chat' : 'search');
            
            addEventListenerWithCleanup(deepThinkButton, 'click', deepThinkHandler);
            addEventListenerWithCleanup(searchButton, 'click', searchHandler);
            
            // Log-Button Event-Listener
            addEventListenerWithCleanup(logButton, 'click', toggleLogOverlay);
            
            document.querySelectorAll('.setting-item').forEach(item => {
                const clickHandler = function() {
                    const radioInput = this.querySelector('input[type="radio"]');
                    if (radioInput) {
                        radioInput.checked = true;
                        document.querySelectorAll('.setting-item').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                    }
                };
                addEventListenerWithCleanup(item, 'click', clickHandler);
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                const changeHandler = function() {
                    document.querySelectorAll('.setting-item').forEach(item => item.classList.remove('active'));
                    const parentItem = this.closest('.setting-item');
                    if (parentItem) parentItem.classList.add('active');
                };
                addEventListenerWithCleanup(radio, 'change', changeHandler);
            });

            // Escape zum Schliessen des Log-Overlays
            addEventListenerWithCleanup(document, 'keydown', function(e) {
                if (e.key === 'Escape' && logOverlay.style.display === 'flex') {
                    logOverlay.style.display = 'none';
                }
            });

            addEventListenerWithCleanup(closeLog, 'click', () => {
                logOverlay.style.display = 'none';
            });

            addEventListenerWithCleanup(refreshLog, 'click', loadLogContent);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            updateServerTitle();
            loadSettings();
            initializeEventListeners();
            updateSettingsUI();
            updateContextEstimation();
        });
        
        window.addEventListener('beforeunload', function() {
            cleanupEventListeners();
        });
    </script>
</body>
</html>

